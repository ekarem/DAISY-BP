__kernel void convolve_7x_vectorised(__global   float * srcArray,
                           __global   float * dstArray,
                           __constant float * fltArray,
                           const      int     arrWidth,
                           const      int     arrHeight,
                           const      int     arrHalo)
{

    const int fullWidth = arrWidth + fltWidth - 1;
    const int dstI = get_global_id(0) + (fullWidth + 1) * (fltWidth / 2) +
                      (get_global_id(0) / arrWidth) * (fltWidth - 1);

    srcArray += dstI - fltWidth / 2;

    float4 v = vload4(0, srcArray);
    float4 u = vload4(0, fltArray);
    float4 w = v * u;

    v = vload4(0, srcArray+3);
    u = vload4(0, fltArray+3);
    w.x -= w.w;
    w += v * u;
    w.x = w.x + w.y + w.z + w.w;

    if(dstI / fullWidth == fltWidth / 2){
      dstArray[dstI] = w.x;
      dstArray[dstI - fullWidth] = w.x;
      dstArray[dstI - fullWidth*2] = w.x;
      dstArray[dstI - fullWidth*3] = w.x;
    }
    else if(dstI / fullWidth == fltWidth / 2 + arrHeight - 1){
      dstArray[dstI] = w.x;
      dstArray[dstI + fullWidth] = w.x;
      dstArray[dstI + fullWidth*2] = w.x;
      dstArray[dstI + fullWidth*3] = w.x;
    }
    else dstArray[dstI] = w.x;

}
